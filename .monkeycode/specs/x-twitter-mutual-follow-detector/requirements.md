# 需求文档

## 引言

X(Twitter) 互关检测与导出插件是一个基于 Plasmo 框架开发的浏览器扩展，用于帮助用户在 X(Twitter) 平台的"正在关注"(Following)列表页面中快速识别互关状态，并支持将关注数据导出为 CSV 文件。该插件通过纯前端 DOM 操作实现，不依赖后端服务，不发送网络请求，完全在用户浏览器本地运行，确保数据安全和隐私保护。

## 词汇表

- **插件系统 (Plugin System)**: 指基于 Plasmo 框架开发的浏览器扩展程序
- **互关 (Mutual Follow)**: 指用户关注了某个账户，且该账户也关注了用户
- **非互关 (Non-Mutual Follow)**: 指用户关注了某个账户，但该账户未关注用户
- **用户条目 (User Cell)**: 指 X(Twitter) 关注列表页面中的单个用户显示元素，对应 DOM 元素 `[data-testid="UserCell"]`
- **互关标识 (Follow Indicator)**: 指 X(Twitter) 在用户条目中显示的 "Follows you" 标记，对应 DOM 元素 `[data-testid="userFollowIndicator"]`
- **蓝 V 标识 (Verified Badge)**: 指 X(Twitter) 认证用户的蓝色勾选标记，对应 DOM 元素 `[data-testid="icon-verified"]`
- **关注列表页面 (Following Page)**: 指 URL 匹配 `https://x.com/*/following*` 的页面
- **内容脚本 (Content Script)**: 指在网页上下文中运行的插件脚本
- **导出按钮 (Export Button)**: 指插件注入到页面中的固定浮动按钮，用于触发数据导出功能
- **CSV 文件 (CSV File)**: 指导出的逗号分隔值文件，包含用户关注数据
- **统计信息栏 (Statistics Bar)**: 指插件在页面顶部注入的固定悬浮元素，用于显示关注统计数据
- **弹出窗口 (Popup)**: 指用户点击浏览器工具栏插件图标时弹出的控制面板，用于管理插件设置

## 需求

### 需求 1: 非互关用户视觉标记

**用户故事:** AS 一个 X(Twitter) 用户，我想要在浏览关注列表时快速识别哪些账户没有关注我，以便我可以决定是否继续关注这些账户。

#### Acceptance Criteria

1. WHEN 用户访问关注列表页面，插件系统 SHALL 自动扫描页面中的所有用户条目
2. WHEN 插件系统检测到用户条目不包含互关标识，插件系统 SHALL 为该用户条目应用浅红色半透明背景样式（建议使用 rgba(255, 68, 68, 0.15)）
3. WHEN 插件系统检测到用户条目不包含互关标识，插件系统 SHALL 在用户名元素后方插入红色文本提示 "（未关注你）"，字体大小为 0.85em，左边距 8px
4. WHILE 用户向下滚动页面加载更多用户条目，插件系统 SHALL 持续监听 DOM 变化并对新加载的用户条目执行检测和标记
5. IF 用户条目已被标记，插件系统 SHALL 跳过该条目，避免重复处理
6. WHILE 插件功能处于禁用状态，插件系统 SHALL 不执行任何视觉标记操作

### 需求 2: 互关统计信息展示

**用户故事:** AS 一个 X(Twitter) 用户，我想要实时查看我的关注列表中有多少人与我互关，有多少人未关注我，以便我了解我的关注关系状况。

#### Acceptance Criteria

1. WHEN 用户访问关注列表页面，插件系统 SHALL 在页面顶部注入固定悬浮的统计信息栏
2. WHEN 统计信息栏创建完成，插件系统 SHALL 设置其样式为固定定位（position: fixed），顶部对齐（top: 0），层级高于页面内容（z-index > 1000）
3. WHEN 插件系统完成用户条目扫描，插件系统 SHALL 计算总关注数和非互关用户数
4. WHEN 插件系统计算完成，插件系统 SHALL 在统计信息栏中显示格式为 "总关注：XXX | 未互关：YYY" 的文本
5. WHILE 用户向下滚动页面加载更多用户条目，插件系统 SHALL 实时更新统计信息栏中的数值
6. IF 页面中没有任何用户条目，插件系统 SHALL 在统计信息栏中显示 "总关注：0 | 未互关：0"
7. WHILE 插件功能处于禁用状态，插件系统 SHALL 隐藏统计信息栏

### 需求 3: 关注数据导出功能

**用户故事:** AS 一个 X(Twitter) 用户，我想要将我的完整关注列表导出为 CSV 文件，包括每个用户的基本信息和互关状态，以便我可以在本地进行数据分析或备份。

#### Acceptance Criteria

1. WHEN 用户访问关注列表页面，插件系统 SHALL 在页面右下角注入固定浮动的导出按钮
2. WHEN 用户点击导出按钮，插件系统 SHALL 开始自动滚动页面，每次滚动距离为视口高度的 1.5 倍
3. WHILE 插件系统执行自动滚动，插件系统 SHALL 在每次滚动后等待随机延迟时间（3 至 6 秒之间）再执行下一次滚动
4. WHILE 插件系统执行自动滚动，插件系统 SHALL 收集所有已加载的用户条目数据，包括显示名称、用户名、互关状态、蓝 V 标识状态和主页链接
5. WHILE 插件系统执行自动滚动，插件系统 SHALL 对收集到的用户数据进行去重处理，确保每个用户仅记录一次
6. WHILE 插件系统执行自动滚动，插件系统 SHALL 在导出按钮旁边显示实时进度信息，格式为 "已加载：XXX 人（滚动中...）"
7. IF 插件系统连续 15 秒内未检测到新的用户条目，插件系统 SHALL 自动停止滚动并触发 CSV 文件生成
8. WHEN 插件系统停止滚动，插件系统 SHALL 生成包含表头 "显示名称,用户名,是否互关,是否蓝V,主页链接" 的 CSV 文件
9. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 使用格式为 "我的关注列表_YYYYMMDD_HHMMSS.csv" 的文件名
10. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 自动触发浏览器下载该文件
11. IF 用户在滚动过程中再次点击导出按钮，插件系统 SHALL 立即停止滚动并触发 CSV 文件生成

### 需求 4: 数据收集与解析

**用户故事:** AS 一个 X(Twitter) 用户，我期望插件准确收集每个关注用户的信息，以确保导出的数据是可靠和完整的。

#### Acceptance Criteria

1. WHEN 插件系统扫描用户条目，插件系统 SHALL 从 DOM 元素 `a[role="link"][href^="/"]` 中提取用户名
2. WHEN 插件系统扫描用户条目，插件系统 SHALL 从 DOM 元素 `div[dir="ltr"] span` 中提取显示名称
3. WHEN 插件系统扫描用户条目，插件系统 SHALL 检查是否存在 DOM 元素 `[data-testid="userFollowIndicator"]` 以判断互关状态
4. WHEN 插件系统扫描用户条目，插件系统 SHALL 检查是否存在 DOM 元素 `[data-testid="icon-verified"]` 以判断蓝 V 标识状态
5. WHEN 插件系统扫描用户条目，插件系统 SHALL 根据提取的用户名生成格式为 `https://x.com/{username}` 的主页链接
6. IF 插件系统无法从用户条目中提取显示名称，插件系统 SHALL 使用默认值 "未知" 作为显示名称
7. IF 插件系统无法从用户条目中提取用户名，插件系统 SHALL 跳过该用户条目，不将其加入收集结果

### 需求 5: 用户交互控制

**用户故事:** AS 一个 X(Twitter) 用户，我希望能够控制插件的运行状态，包括启动、停止导出过程，以及在需要时移除视觉标记。

#### Acceptance Criteria

1. WHEN 用户点击导出按钮开始导出，插件系统 SHALL 将导出按钮文本更新为 "滚动中...点击停止"
2. WHEN 导出过程完成或被用户手动停止，插件系统 SHALL 将导出按钮文本更新为 "导出完成！重新点击可再次导出"
3. WHEN 导出过程完成，插件系统 SHALL 禁用导出按钮，直到用户刷新页面
4. IF 收集到的用户数据为空，插件系统 SHALL 显示警告提示 "未收集到任何用户数据"，并且不生成 CSV 文件
5. WHILE 插件系统正在执行自动滚动，插件系统 SHALL 允许用户通过再次点击导出按钮来强制停止滚动

### 需求 6: 性能与资源管理

**用户故事:** AS 一个 X(Twitter) 用户，我希望插件不会显著影响页面性能或导致浏览器卡顿。

#### Acceptance Criteria

1. WHEN 插件系统使用 MutationObserver 监听 DOM 变化，插件系统 SHALL 仅观察 `document.body` 元素，配置选项为 `{ childList: true, subtree: true }`
2. WHEN 插件系统处理用户条目时，插件系统 SHALL 在插入视觉标记元素前检查是否已存在标记，避免重复添加
3. WHEN 插件系统收集用户数据时，插件系统 SHALL 使用 Map 数据结构以用户名为键进行去重
4. WHEN 导出过程完成，插件系统 SHALL 清除所有定时器和事件监听器，释放相关资源
5. WHEN 插件系统生成 CSV Blob 对象并触发下载后，插件系统 SHALL 使用 `URL.revokeObjectURL()` 释放对象 URL 资源

### 需求 7: 安全与隐私保护

**用户故事:** AS 一个 X(Twitter) 用户，我期望插件不会泄露我的数据，不会向外部服务器发送任何信息。

#### Acceptance Criteria

1. The 插件系统 SHALL 仅在用户浏览器本地运行，不向任何外部服务器发送网络请求
2. The 插件系统 SHALL 仅使用浏览器存储 API（chrome.storage.local）存储插件配置信息（如主开关状态），不存储任何用户数据或关注列表数据
3. The 插件系统 SHALL 仅在 URL 匹配 `https://x.com/*/following*` 的页面上运行内容脚本
4. The 插件系统 SHALL 不请求除 `host_permissions` 为 `https://x.com/*` 和 `storage` 权限之外的任何额外浏览器权限
5. WHEN 用户关闭或刷新页面，插件系统 SHALL 清除所有临时收集的用户数据

### 需求 8: CSV 文件格式规范

**用户故事:** AS 一个 X(Twitter) 用户，我希望导出的 CSV 文件格式标准，可以被 Excel、Google Sheets 等工具正确打开。

#### Acceptance Criteria

1. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 在文件开头添加 UTF-8 BOM 标记 `\ufeff`
2. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 使用逗号作为字段分隔符
3. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 对所有字段值使用双引号包裹
4. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 使用换行符 `\n` 作为行分隔符
5. WHEN 插件系统生成 CSV 文件，插件系统 SHALL 在第一行输出表头 "显示名称,用户名,是否互关,是否蓝V,主页链接"
6. WHEN 插件系统填充互关状态字段，插件系统 SHALL 使用文本 "是" 表示互关，使用文本 "否" 表示非互关
7. WHEN 插件系统填充蓝 V 标识状态字段，插件系统 SHALL 使用文本 "是" 表示已认证，使用文本 "否" 表示未认证

### 需求 9: 插件功能控制（Popup 面板）

**用户故事:** AS 一个 X(Twitter) 用户，我希望能够通过插件的弹出窗口快速启用或禁用插件的各项功能，以便我在不需要时暂时关闭插件。

#### Acceptance Criteria

1. WHEN 用户点击浏览器工具栏中的插件图标，插件系统 SHALL 打开弹出窗口
2. WHEN 弹出窗口打开，插件系统 SHALL 显示插件名称、版本号和简短描述
3. WHEN 弹出窗口打开，插件系统 SHALL 显示一个主开关控件，用于启用或禁用所有插件功能
4. WHEN 用户切换主开关至启用状态，插件系统 SHALL 在关注列表页面激活视觉标记功能和统计信息展示功能
5. WHEN 用户切换主开关至禁用状态，插件系统 SHALL 在关注列表页面移除所有视觉标记和隐藏统计信息栏
6. WHEN 用户修改主开关状态，插件系统 SHALL 使用浏览器存储 API（chrome.storage.local）持久化保存该状态
7. WHEN 插件系统启动时，插件系统 SHALL 从浏览器存储中读取主开关状态，并应用该状态
8. IF 浏览器存储中没有主开关状态记录，插件系统 SHALL 默认将主开关设置为启用状态
9. WHEN 弹出窗口显示，插件系统 SHALL 在底部显示文本说明："本插件仅在本地运行，不收集或上传任何数据"

### 需求 10: 错误处理与容错

**用户故事:** AS 一个 X(Twitter) 用户，我希望即使 X(Twitter) 页面结构发生细微变化，插件也能尽可能正常工作，或至少给出友好的错误提示。

#### Acceptance Criteria

1. IF 插件系统无法找到目标 DOM 元素 `[data-testid="UserCell"]`，插件系统 SHALL 继续监听 DOM 变化，等待元素出现
2. IF 插件系统在提取用户信息时遇到 DOM 结构异常，插件系统 SHALL 跳过该用户条目，继续处理后续条目
3. IF 插件系统生成 CSV Blob 失败，插件系统 SHALL 显示警告提示 "CSV 文件生成失败"
4. IF 插件系统触发下载失败，插件系统 SHALL 显示警告提示 "文件下载失败，请检查浏览器下载权限"
5. WHILE 插件系统执行自动滚动，IF 页面加载缓慢导致新用户条目延迟出现，插件系统 SHALL 等待最多 15 秒后再判定已到达列表底部
